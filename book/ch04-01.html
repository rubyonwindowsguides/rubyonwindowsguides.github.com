<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Ruby And Ole</title>
   <meta name="author" content="Boško Ivanišević" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection" />
   <link rel="stylesheet" href="/css/syntax.css" type="text/css" media="screen, projection" />
   <link rel="stylesheet" href="/css/menu.css" type="text/css" media="screen, projection" />

   <!-- Update your html tag to include the itemscope and itemtype attributes -->
   <html itemscope itemtype="http://schema.org/Book">

   <!-- Add the following three tags inside head -->
   <meta itemprop="name" content="Ruby On Windows Guides">

   <!-- Place this render call where appropriate -->
   <script type="text/javascript">
      (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })();
   </script>

   <script type="text/javascript">

     var _gaq = _gaq || [];
     _gaq.push(['_setAccount', 'UA-26061460-1']);
     _gaq.push(['_trackPageview']);

     (function() {
     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
     })();

   </script>
</head>
<body>
  <header>
  </header>
  <main class="content">
    <section class="container">
      <nav class="navbar-fixed-top">
        <div class="container">
          <a href="/">Book</a>
          <a href="/about.html">About</a>
          <span style="float: right;">
            <!-- Place this tag where you want the +1 button to render -->
            <g:plusone annotation="inline"></g:plusone>
          </span>
        </div>
      </nav>
      <div id="header">
        <table>
          <tr>
            <td>
              <h1>Ruby on Windows Guides</h1>
              <h4 class="title">by Boško Ivanišević</h4>
            </td>
          </tr>
        </table>
      </div>
      <div id="main" class="row-fluid">
        <article class="post">
      <section style="font-weight:bold; margin-bottom: 2em;">
        
        <a rel="prev" class="a-hover"href="/book/ch04-00.html"><i class="icon-double-angle-left"></i> Programming On Windows</a>
        
        
        <a rel="next" style="float:right" class="a-hover"href="/book/ch04-02.html">Internet Explorer Automation <i class=" icon-double-angle-right"></i></a>
        
            <hr>
      </section>

          <section>
            <h2>Ruby and OLE</h2>

<p>Object Linking and Embedding (OLE) is technology that enables an application to create compound documents. Using OLE any document can contain visual information from various sources. OLE-enabled application, without knowing internal data structure, is capable to display spreadsheet table, video, sound and numerous other formats. Moreover these objects preserve their properties and if user wants to change them, Windows will activate originating application. OLE was introduced to overcome problems with traditional cut and paste approach which used data transforming in a way that host application understands and can display.</p>

<p>Later, technology evolved to OLE 2 based on Component Object Model (COM), binary-interface standard for inter-process communication and dynamic object creation. COM was intended for use by various scripting languages. Nowadays it can be used from almost all languages that run on Windows: C, C++, Visual Basic and, of course, Ruby.</p>

<p>Using OLE in Ruby scripts is managed through win32ole extension. We&#39;ll start exploring Ruby and OLE objects through couple one-liners which will give us good starting insight in OLE objects that exist in operating system. Later on we will see what additional data about existing OLE objects we can collect from Ruby. Finally we will learn how to automate few Windows applications through Ruby scripts.</p>

<p>Let&#39;s start with one simple one-liner which will print out all OLE objects registered in the system:</p>

<div class="highlight"><pre><code class="bat">c:\<span class="p">&gt;</span><span class="n">ruby</span> -rwin<span class="m">32</span>ole -e <span class="s2">&quot;puts WIN32OLE_TYPE.typelibs.sort&quot;</span>
AP Client <span class="m">1</span>.<span class="m">0</span> HelpPane Type Library
AP Client <span class="m">1</span>.<span class="m">0</span> Type Library
ATL <span class="m">2</span>.<span class="m">0</span> Type Library
ATLContactPicker <span class="m">1</span>.<span class="m">3</span> Type Library
ATLEntityPicker <span class="m">1</span>.<span class="m">0</span> Type Library
AccessibilityCplAdmin <span class="m">1</span>.<span class="m">0</span> Type Library
Active DS Type Library
ActiveMovie control type library
AgControl <span class="m">5</span>.<span class="m">1</span> Type Library
AppIdPolicyEngineApi <span class="m">1</span>.<span class="m">0</span> Type Library
Assistance Platform Client <span class="m">1</span>.<span class="m">0</span> Data Services Type Library
BCS Launcher <span class="m">2</span>.<span class="m">0</span> Type Library
BdeUISrv <span class="m">1</span>.<span class="m">0</span> Type Library
BinaryInfo <span class="m">1</span>.<span class="m">0</span> Type Library
Bined package <span class="m">11</span>.<span class="m">0</span> Type Library
Bined package <span class="m">12</span>.<span class="m">0</span> Type Library
Bined package <span class="m">8</span>.<span class="m">0</span> Type Library
:    :     :</code></pre></div>

<p>What we did with this one-liner? We told ruby to load win32ole extension (<code>-r win32ole</code>) and to print array of names of all type libraries registered in the system (<code>-e “puts WIN32OLE_TYPE.typelibs.sort”</code>). Type libraries contain metadata about COM types. Ruby reads this data with the help of another <code>win32ole</code> class – <code>WIN32OLE_TYPELIB</code>. This class&#39; internal method reads entries from the registry key <code>HKCR\TypeLib</code> and collects all properties of registered type libraries like name, version and path on the disk. <code>WIN32OLE_TYPE</code> extracts these type libraries names and stores them in the array. Knowing this we can use <code>WIN32OLE_TYPELIB</code> class to display more information about existing COM objects:</p>

<div class="highlight"><pre><code class="bat">c:\<span class="p">&gt;</span><span class="n">ruby</span> -rwin<span class="m">32</span>ole -e <span class="s1">&#39;puts &quot;#{WIN32OLE_TYPELIB.typelibs[0].name}:  #{WIN32OLE_TYPELIB.typelibs[0].path}&quot;&#39;</span>

Microsoft ActiveX Data Objects <span class="m">2</span>.<span class="m">0</span> Library:  C:\Program Files (x<span class="m">86</span>)\Common Files\System\ado\msado<span class="m">20</span>.tlb</code></pre></div>

<p>This time we displayed not only the name but also the path of the type library on the file system. Information obtained through <code>WIN32OLE_TYPELIB</code> is not of much use, but it can be good starting point for exploring OLE objects that exist in the system.</p>

<p>Each type library usually contains more classes. List of classes are returned by <code>ole_classes</code>, <code>WIN32OLE_TYPE</code>&#39;s class method which accepts one argument, name of type library:</p>

<div class="highlight"><pre><code class="bat">c:\<span class="p">&gt;</span><span class="n">ruby</span> -rwin<span class="m">32</span>ole -e <span class="s2">&quot;puts WIN32OLE_TYPE.ole_classes(&#39;Microsoft Scripting Runtime&#39;)&quot;</span>
CompareMethod
IOMode
Tristate
FileAttribute
:    :    :
FileSystemObject
Drive
Drives
Folder
Folders
File
Files
TextStream
IScriptEncoder
Encoder</code></pre></div>

<p>Method <code>ole_classes</code> returns array of <code>WIN32OLE_TYPE</code> objects but Ruby&#39;s puts method, when called with array as an argument, iterates over all objects in the array and calls <code>to_s</code> method for each member of array. <code>WIN32OLE_TYPE</code> objects return name of the OLE type as a result of <code>to_s</code> method. But there is much more information that <code>WIN32OLE_TYPE</code> object contains then just a name as you can see from the irb session displayed below.</p>

<div class="highlight"><pre><code class="bat">C:\<span class="p">&gt;</span><span class="n">irb</span> -r win<span class="m">32</span>ole
irb(main)<span class="nl">:001:0</span><span class="p">&gt;</span> <span class="n">WIN32OLE_TYPE</span>.ole_classes(<span class="s2">&quot;Microsoft Scripting Runtime&quot;</span>)[<span class="m">22</span>].name
<span class="o">=</span>&gt; <span class="s2">&quot;FileSystemObject&quot;</span>
irb(main)<span class="nl">:002:0</span><span class="p">&gt;</span> <span class="n">WIN32OLE_TYPE</span>.ole_classes(<span class="s2">&quot;Microsoft Scripting Runtime&quot;</span>)[<span class="m">22</span>].guid
<span class="o">=</span>&gt; <span class="s2">&quot;{0D43FE01-F093-11CF-8940-00A0C9054228}&quot;</span>
irb(main)<span class="nl">:003:0</span><span class="p">&gt;</span> <span class="n">WIN32OLE_TYPE</span>.ole_classes(<span class="s2">&quot;Microsoft Scripting Runtime&quot;</span>)[<span class="m">22</span>].progid
<span class="o">=</span>&gt; <span class="s2">&quot;Scripting.FileSystemObject&quot;</span></code></pre></div>

<p>As you can see name of the OLE type is exactly the one displayed in the command prompt when we printed array of classes in Microsoft Scripting Runtime type library. Further, we see this class&#39; GUID and ProgID. Globally unique identifier (GUID) is 32 character hexadecimal string which uniquely identifies OLE type. ProgID is string that corresponds to GUID and also identifies OLE type. Both of these values can be used when we instantiate object of particular OLE type.</p>

<p>Let&#39;s create new OLE object now and check what data about OLE type we can get from it.</p>

<div class="highlight"><pre><code class="bat">c:\<span class="p">&gt;</span><span class="n">irb</span> -rwin<span class="m">32</span>ole
irb(main)<span class="nl">:001:0</span><span class="p">&gt;</span> <span class="n">fso</span> <span class="o">=</span> WIN<span class="m">32</span>OLE_TYPE.new(<span class="s2">&quot;Microsoft Scripting Runtime&quot;</span><span class="p">,</span> <span class="s2">&quot;FileSystemObject&quot;</span>)
<span class="o">=</span>&gt; #<span class="p">&lt;</span><span class="n">WIN32OLE_TYPE</span><span class="nl">:FileSystemObject</span><span class="p">&gt;</span>
<span class="n">irb</span>(main)<span class="nl">:002:0</span><span class="p">&gt;</span> <span class="n">fso</span>.ole_methods.length
<span class="o">=</span><span class="p">&gt;</span> <span class="n">34</span>
irb(main)<span class="nl">:003:0</span><span class="p">&gt;</span> <span class="n">fso</span>.ole_methods[<span class="m">17</span>].invoke_kind
<span class="o">=</span>&gt; <span class="s2">&quot;FUNC&quot;</span>
irb(main)<span class="nl">:004:0</span><span class="p">&gt;</span> <span class="n">fso</span>.ole_methods[<span class="m">17</span>].return_type
<span class="o">=</span>&gt; <span class="s2">&quot;BOOL&quot;</span>
irb(main)<span class="nl">:005:0</span><span class="p">&gt;</span> <span class="n">fso</span>.ole_methods[<span class="m">17</span>].name
<span class="o">=</span>&gt; <span class="s2">&quot;FileExists&quot;</span>
irb(main)<span class="nl">:006:0</span><span class="p">&gt;</span> <span class="n">fso</span>.ole_methods[<span class="m">17</span>].helpstring
<span class="o">=</span>&gt; <span class="s2">&quot;Check if a file exists&quot;</span>
irb(main)<span class="nl">:007:0</span><span class="p">&gt;</span> <span class="n">params</span> <span class="o">=</span> fso.ole_methods[<span class="m">17</span>].params
<span class="o">=</span>&gt; [#<span class="p">&lt;</span><span class="n">WIN32OLE_PARAM</span><span class="nl">:FileSpec</span>&gt;]
irb(main)<span class="nl">:008:0</span><span class="p">&gt;</span> <span class="n">params</span>[<span class="m">0</span>].input?
<span class="o">=</span><span class="p">&gt;</span> <span class="n">true</span>
irb(main)<span class="nl">:009:0</span><span class="p">&gt;</span> <span class="n">params</span>[<span class="m">0</span>].ole_type
<span class="o">=</span>&gt; <span class="s2">&quot;BSTR&quot;</span>
irb(main)<span class="nl">:010:0</span><span class="p">&gt;</span> <span class="n">params</span>[<span class="m">0</span>].name
<span class="o">=</span>&gt; <span class="s2">&quot;FileSpec&quot;</span>
irb(main)<span class="nl">:011:0</span><span class="p">&gt;</span> <span class="n">params</span>[<span class="m">0</span>].default
<span class="o">=</span><span class="p">&gt;</span> <span class="n">nil</span></code></pre></div>

<p>In the first statement we are creating <code>WIN32OLE_TYPE</code> object, <code>FileSystemObject</code>, from Microsoft Scripting Runtime type library. In the next step we are reading number of OLE methods that are defined in the OLE object. Statements that follow display various properties of one particular OLE method.</p>

<p>The first one shows that this OLE method is actually a function. Possible values that can be returned from <code>invoke_kind</code> are:</p>

<ul>
<li><code>UNKNOWN</code> – for undefined OLE methods</li>
<li><code>PROPERTY</code> – indicates that the method can be called using standard property-access or property value assignment syntax</li>
<li><code>PROPERTYGET</code> – indicates that the method is called using standard property-access syntax</li>
<li><code>PROPERTYPUT</code> – indicates that the method is called using standard property value assignment syntax</li>
<li><code>PROPERTYPUTREF</code> – indicates that the method is called using property reference assignment syntax</li>
<li><code>FUNC</code> –indicates that the method is called using standard function invocation syntax</li>
</ul>

<p>Later commands display method&#39;s name, return type and help string. Finally, information about method&#39;s parameters are examined.</p>

<p>We can now extend our Ruby on Rails application to display information about registered OLE objects. Since we are gathering data directly from the system we will not need new database model. Go to the <code>rwin_book</code> application directory and invoke one of Rails generators that will create new controller with index method only:</p>

<div class="highlight"><pre><code class="bat">c:\projects\rwin_book<span class="p">&gt;</span><span class="n">rails</span> generate controller OleExplorer index
      create  app<span class="n">/controllers/ole_explorer_controller.rb</span>
       route  get <span class="s1">&#39;ole_explorer/index&#39;</span>
      invoke  erb
      create    app<span class="n">/views/ole_explorer</span>
      create    app<span class="n">/views/ole_explorer/index.html.erb</span>
      invoke  test_unit
      create    test<span class="n">/controllers/ole_explorer_controller_test.rb</span>
      invoke  helper
      create    app<span class="n">/helpers/ole_explorer_helper.rb</span>
      invoke    test_unit
      create      test<span class="n">/helpers/ole_explorer_helper_test.rb</span>
      invoke  assets
      invoke    coffee
      create      app<span class="n">/assets/javascripts/ole_explorer.js.coffee</span>
      invoke    scss
      create      app<span class="n">/assets/stylesheets/ole_explorer.css.scss</span></code></pre></div>

<p>The generator logs everything to console. From this point we can proceed in several ways. Code that extracts OLE information can all be part of the new controller. We can also put it in the <code>ole_explorer_helper.rb</code> file or, as we will do, create new library and put complete OLE related code there.</p>

<p>Create new file in the lib directory within your application&#39;s directory and put following code in it:</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;win32ole&#39;</span>

<span class="k">module</span> <span class="nn">WinOle</span>
  <span class="k">class</span> <span class="nc">OleExplorer</span>
    <span class="k">def</span> <span class="nf">typelibs</span>
      <span class="vi">@typelibs</span> <span class="o">||=</span> <span class="no">WIN32OLE_TYPELIB</span><span class="o">.</span><span class="n">typelibs</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span><span class="o">|</span><span class="n">tl</span><span class="o">|</span> <span class="n">tl</span><span class="o">.</span><span class="n">name</span> <span class="k">unless</span> <span class="n">tl</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">ole_classes</span><span class="p">(</span><span class="n">typelib</span><span class="p">)</span>
      <span class="k">begin</span>
        <span class="no">WIN32OLE_TYPE</span><span class="o">.</span><span class="n">ole_classes</span><span class="p">(</span><span class="n">typelib</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span><span class="o">|</span><span class="n">oc</span><span class="o">|</span> <span class="n">oc</span><span class="o">.</span><span class="n">name</span><span class="p">}</span><span class="o">.</span><span class="n">sort</span>
      <span class="k">rescue</span>
        <span class="o">[]</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">ole_members</span><span class="p">(</span><span class="n">typelib</span><span class="p">,</span> <span class="n">klass</span><span class="p">)</span>
      <span class="k">begin</span>
        <span class="n">ot</span> <span class="o">=</span> <span class="no">WIN32OLE_TYPE</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">typelib</span><span class="p">,</span> <span class="n">klass</span><span class="p">)</span>
        <span class="n">members</span> <span class="o">=</span> <span class="p">(</span><span class="n">ot</span><span class="o">.</span><span class="n">ole_methods</span> <span class="o">+</span> <span class="n">ot</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">om</span><span class="o">|</span> <span class="n">om</span><span class="o">.</span><span class="n">name</span><span class="p">}</span><span class="o">.</span><span class="n">sort</span>
        <span class="p">{</span><span class="ss">:class</span><span class="o">=&gt;</span><span class="n">ot</span><span class="p">,</span> <span class="ss">:members</span><span class="o">=&gt;</span><span class="n">members</span><span class="p">}</span>
      <span class="k">rescue</span>
        <span class="p">{</span><span class="ss">:members</span><span class="o">=&gt;[]</span><span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">ole_member</span><span class="p">(</span><span class="n">typelib</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
      <span class="k">begin</span>
        <span class="n">ot</span> <span class="o">=</span> <span class="no">WIN32OLE_TYPE</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">typelib</span><span class="p">,</span> <span class="n">klass</span><span class="p">)</span>
        <span class="p">(</span><span class="n">ot</span><span class="o">.</span><span class="n">ole_methods</span> <span class="o">+</span> <span class="n">ot</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span><span class="o">|</span><span class="n">mem</span><span class="o">|</span> <span class="n">mem</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">member</span><span class="p">}</span>
      <span class="k">rescue</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>We created new WinOle module with class <code>OleExplorer</code> in it. The first method <code>typelibs</code> returns an array of names of all type libraries found in the system. The second one returns an array with names of all classes defined in a type library whose name is passed as an argument. Next one returns hash which has two keys if requested class is found in the type library. First key, <code>:class</code>, has <code>WIN32OLE_TYPE</code> object as a value, and the second, <code>:members</code>, contains an array with names of all members of the class. When requested class is not found method returns only empty array in the <code>:members</code> key. Finally the last method returns member of the class or <code>nil</code>. This member can be <code>WIN32OLE_METHOD</code> or <code>WIN32OLE_VARIABLE</code> object.</p>

<p>With this library in place our <code>OleExplorerController</code> can use <code>WinOle::OleExplorer</code> class to collect OLE data and display them to the user in the view. This trivial example will use three drop-down select boxes for choosing type library, class and member of the class. In the controller we will use <code>OleExplorer</code> class to fetch all type libraries registered in the system.</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s2">&quot;ole_explorer&quot;</span>

<span class="k">class</span> <span class="nc">OleExplorerController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@typelibs</span> <span class="o">=</span> <span class="n">ole_explorer</span><span class="o">.</span><span class="n">typelibs</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">tl</span><span class="o">|</span> <span class="n">tl</span><span class="o">.</span><span class="n">name</span><span class="p">}</span><span class="o">.</span><span class="n">sort</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">ole_explorer</span>
    <span class="vi">@ole_explorer</span> <span class="o">||=</span> <span class="no">WinOle</span><span class="o">::</span><span class="no">OleExplorer</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>In the template file <code>index.html.erb</code> we will use instance variable <code>@typelibs</code> to display all type libraries in the select box.</p>

<div class="highlight"><pre><code class="ruby"><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="no">OleExplorer</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
<span class="sr">&lt;%= select &quot;typelib&quot;, &quot;typelib&quot;, @typelibs, {:prompt=&gt;&quot;Select Type Library&quot;}  %&gt;</span></code></pre></div>

<p>If you now start rails server and load <code>http://localhost:3000/ole_explorer/index</code> page you will see select box filled with all type libraries registered in the system (Figure 12).</p>

<p><img src="/images/fig0401.png" alt="&quot;&quot;" title="Select box with all registered type libraries."></p>

<p>Next we want to read all classes in a type library whenever user changes selected type library. We will do that through Ajax request. Let&#39;s add JavaScript change event handler on our select box. To keep things simple we will put all JavaScript code directly in <code>application.js</code> file.</p>

<div class="highlight"><pre><code class="js"><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#typelib_typelib&quot;</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span>
      <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;/ole_explorer/update_classes&#39;</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">typelib</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">},</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;script&#39;</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre></div>

<p>New JavaScript method will send GET request to the <code>OleExplorer</code> controller, call <code>update_classes</code> method and pass the name of the selected type library. We are still missing <code>update_classes</code> method in the controller so let&#39;s add it now:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">update_classes</span>
  <span class="vi">@ole_classes</span> <span class="o">=</span> <span class="no">WinOle</span><span class="o">::</span><span class="no">OleExplorer</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">ole_classes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:typelib</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>

<p>New method will collect names of all classes in the type library. Since we are sending Ajax request Rails will automatically search for <code>update_classes.js.erb</code> view file which it will render. This file can be used to execute JavaScript on the client and to replace HTML code on the page. Create new view file <code>update_classes.js.erb</code> and add following code to it:</p>

<div class="highlight"><pre><code class="js"><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#ole_classes&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;%= escape_javascript(render &#39;</span><span class="nx">ole_classes</span><span class="s1">&#39;) %&gt;&#39;</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#ole_class_ole_class&quot;</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;/ole_explorer/update_members&#39;</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">ole_class</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="nx">typelib</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#typelib_typelib&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">},</span>
    <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;script&#39;</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre></div>

<p>Before we can check our new code we have to create partial template <code>_ole_classes.html.erb</code> in the <code>app/views/ole_explorer</code> directory and add new route to <code>routes.rb</code> file. Go ahead and create new partial and add following code to it.</p>

<div class="highlight"><pre><code class="ruby"><span class="o">&lt;</span><span class="sx">%= select &quot;ole_class&quot;, &quot;ole_class&quot;, @ole_classes, {:prompt=</span><span class="o">&gt;</span><span class="s2">&quot;Select OLE class&quot;</span><span class="p">}</span> <span class="o">%&gt;</span></code></pre></div>

<p>Finally change <code>routes.rb</code>:</p>

<div class="highlight"><pre><code class="ruby"><span class="no">RwinBook</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;ole_explorer/index&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;ole_explorer/update_classes&quot;</span>

  <span class="n">resources</span> <span class="ss">:ruby_win_sources</span>
<span class="k">end</span></code></pre></div>

<p>change <code>index</code> method in <code>OleExplorerController</code>:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">index</span>
  <span class="vi">@typelibs</span> <span class="o">=</span> <span class="n">ole_explorer</span><span class="o">.</span><span class="n">typelibs</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">tl</span><span class="o">|</span> <span class="n">tl</span><span class="o">.</span><span class="n">name</span><span class="p">}</span><span class="o">.</span><span class="n">sort</span>
  <span class="vi">@ole_classes</span> <span class="o">=</span> <span class="o">[]</span>
<span class="k">end</span></code></pre></div>

<p>and add the following lines to the end of the <code>index.html.erb</code> file:</p>

<div class="highlight"><pre><code class="html"><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;ole_classes&quot;</span><span class="nt">&gt;</span>
  <span class="err">&lt;</span>%= render :partial =&gt; &#39;ole_classes&#39;, :object =&gt; @ole_classes %&gt;
<span class="nt">&lt;/div&gt;</span></code></pre></div>

<p>Now reload the page in the browser and new select box will be displayed, filled with new names of classes whenever you change selected type library.</p>

<p>In the next iteration of improving this quite trivial Rails example we want to display general information about selected class, its members and information about selected member within the class. Let&#39;s first add two new partial templates. The first one, <code>_ole_members.html.erb</code>, will display general class information and select box with names of all members of selected class.</p>

<div class="highlight"><pre><code class="html"><span class="err">&lt;</span>% if @ole_members[:class] %&gt;
  <span class="nt">&lt;h3&gt;</span>Class Info<span class="nt">&lt;/h3&gt;</span>

  <span class="nt">&lt;p&gt;</span>Name: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @ole_members[:class].name %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>GUID: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @ole_members[:class].guid %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>ProgID: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @ole_members[:class].progid %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>Desc: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @ole_members[:class].helpstring %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
<span class="err">&lt;</span>% end %&gt;
<span class="err">&lt;</span>%= select(&quot;ole_member&quot;, &quot;ole_member&quot;, @ole_members[:members],
           {:prompt=&gt;&quot;Select OLE member&quot;}) %&gt;</code></pre></div>

<p>Again we have to handle selected member change so we need to add following code to <code>update_members.js.erb</code> file:</p>

<div class="highlight"><pre><code class="js"><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#ole_members&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;%= escape_javascript(render &#39;</span><span class="nx">ole_members</span><span class="s1">&#39;) %&gt;&#39;</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#ole_member_ole_member&quot;</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;/ole_explorer/member_info&#39;</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">member</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
            <span class="nx">ole_class</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#ole_class_ole_class&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
            <span class="nx">typelib</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#typelib_typelib&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">},</span>
    <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;script&#39;</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre></div>

<p>Below the heading we display class name, GUID, ProgID and help string. After that we fill select box with all members of selected class. Similarly to previous two select boxes we are using <code>onchange</code> event to send Ajax request to the server whenever selected member is changed. This time we are sending three values in the request: names of member, class and type library.</p>

<p>Second partial, <code>_member_info.html.erb</code>, displays information about requested member:</p>

<div class="highlight"><pre><code class="html"><span class="err">&lt;</span>% unless @member.nil? %&gt;
  <span class="nt">&lt;h3&gt;</span>Member info<span class="nt">&lt;/h3&gt;</span>
  <span class="err">&lt;</span>% if @member.is_a? WIN32OLE_METHOD %&gt;
    <span class="err">&lt;</span>% if @member.event? %&gt;
      <span class="nt">&lt;p&gt;&lt;i&gt;</span>Event<span class="nt">&lt;/i&gt;&lt;/p&gt;</span>
      <span class="nt">&lt;p&gt;</span>Event interface: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @member.event_interface %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
    <span class="err">&lt;</span>% end %&gt;
    <span class="nt">&lt;p&gt;</span>Name: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @member.name %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Invoke: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @member.invoke_kind %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Returns: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @member.return_type %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Dispatch ID: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @member.dispid %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Help string: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @member.helpstring %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;&lt;i&gt;</span>Arguments<span class="nt">&lt;/i&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">border=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;tr&gt;&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;&lt;th&gt;</span>Type<span class="nt">&lt;/th&gt;&lt;th&gt;</span>Usage<span class="nt">&lt;/th&gt;&lt;/tr&gt;</span>
      <span class="err">&lt;</span>% @member.params.each do |param| %&gt;
        <span class="nt">&lt;tr&gt;</span>
          <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= param.name %&gt;<span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= param.ole_type %&gt;<span class="nt">&lt;/td&gt;</span>
          <span class="err">&lt;</span>% parinf = [] %&gt;
          <span class="err">&lt;</span>% parinf <span class="err">&lt;&lt;</span> &quot;In&quot; if param.input? %&gt;
          <span class="err">&lt;</span>% parinf <span class="err">&lt;&lt;</span> &quot;Out&quot; if param.output? %&gt;
          <span class="err">&lt;</span>% parinf <span class="err">&lt;&lt;</span> &quot;Optional&quot; if param.optional? %&gt;
          <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= parinf.join(&#39;,&#39;) %&gt;<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
      <span class="err">&lt;</span>% end -%&gt;
    <span class="nt">&lt;/table&gt;</span>
  <span class="err">&lt;</span>% else %&gt;
    <span class="nt">&lt;p&gt;&lt;i&gt;</span>Variable<span class="nt">&lt;/i&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Name: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @member.name %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Kind: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @member.variable_kind %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>Type: <span class="nt">&lt;b&gt;</span><span class="err">&lt;</span>%= @member.ole_type %&gt;<span class="nt">&lt;/b&gt;&lt;/p&gt;</span>
  <span class="err">&lt;</span>% end %&gt;
<span class="err">&lt;</span>% end %&gt;</code></pre></div>

<p>On the server-side, values of parameters from Ajax request are extracted and used to read information about class&#39; member. Full listing of code in the controller is given below.</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s2">&quot;ole_explorer&quot;</span>

<span class="k">class</span> <span class="nc">OleExplorerController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@typelibs</span> <span class="o">=</span> <span class="no">WinOle</span><span class="o">::</span><span class="no">OleExplorer</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">typelibs</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">tl</span><span class="o">|</span> <span class="n">tl</span><span class="o">.</span><span class="n">name</span><span class="p">}</span><span class="o">.</span><span class="n">sort</span>
    <span class="vi">@ole_classes</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="vi">@ole_members</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:members</span><span class="o">=&gt;[]</span><span class="p">}</span>
    <span class="vi">@member</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update_classes</span>
    <span class="vi">@ole_members</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">members</span><span class="p">:</span> <span class="o">[]</span> <span class="p">}</span>
    <span class="vi">@ole_classes</span> <span class="o">=</span> <span class="no">WinOle</span><span class="o">::</span><span class="no">OleExplorer</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">ole_classes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:typelib</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update_members</span>
    <span class="vi">@ole_members</span> <span class="o">=</span> <span class="no">WinOle</span><span class="o">::</span><span class="no">OleExplorer</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">ole_members</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:typelib</span><span class="o">]</span><span class="p">,</span><span class="n">params</span><span class="o">[</span><span class="ss">:ole_class</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">member_info</span>
    <span class="vi">@member</span> <span class="o">=</span> <span class="no">WinOle</span><span class="o">::</span><span class="no">OleExplorer</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">ole_member</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:typelib</span><span class="o">]</span><span class="p">,</span>
      <span class="n">params</span><span class="o">[</span><span class="ss">:ole_class</span><span class="o">]</span><span class="p">,</span>
      <span class="n">params</span><span class="o">[</span><span class="ss">:member</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>Finally we have to add new partial templates to our index page:</p>

<div class="highlight"><pre><code class="html"><span class="nt">&lt;h1&gt;</span>OleExplorer<span class="nt">&lt;/h1&gt;</span>
<span class="err">&lt;</span>%= select &quot;typelib&quot;, &quot;typelib&quot;, @typelibs, {:prompt=&gt;&quot;Select Type Library&quot;}  %&gt;

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;ole_classes&quot;</span><span class="nt">&gt;</span>
  <span class="err">&lt;</span>%= render :partial =&gt; &#39;ole_classes&#39;, :object =&gt; @ole_classes %&gt;
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;ole_members&quot;</span><span class="nt">&gt;</span>
  <span class="err">&lt;</span>%= render :partial =&gt; &#39;ole_members&#39; %&gt;
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;member_info&quot;</span><span class="nt">&gt;</span>
  <span class="err">&lt;</span>%= render :partial =&gt; &#39;member_info&#39;, :object =&gt; @member %&gt;
<span class="nt">&lt;/div&gt;</span></code></pre></div>

<p>handle Ajax call to <code>member_info</code> method (file <code>member_info.js.erb</code>)</p>

<div class="highlight"><pre><code class="js"><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#member_info&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;%= escape_javascript(render partial: &#39;</span><span class="nx">member_info</span><span class="s1">&#39;) %&gt;&#39;</span><span class="p">);</span></code></pre></div>

<p>and to add two new routes:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">get</span> <span class="s2">&quot;ole_explorer/update_members&quot;</span>
<span class="n">get</span> <span class="s2">&quot;ole_explorer/member_info&quot;</span></code></pre></div>

<p>Now we have full-featured page for exploring all registered OLE types in the system. Start Rails application and load the page. Output should look similar to the one shown in Figure 13.</p>

<p><img src="/images/fig0402.png" alt="&quot;&quot;" title="Full-featured OLE explorer view."></p>

<p>Complete Rails code for this chapter can be found in <a href="https://github.com/bosko/rwin_book_code">RWin Book Code</a> on the GitHub in the branch <code>ole_explorer</code>.</p>

            <hr>
          </section>

      <section style="font-weight:bold; margin-bottom: 2em;">
        
        <a rel="prev" class="a-hover"href="/book/ch04-00.html"><i class="icon-double-angle-left"></i> Programming On Windows</a>
        
        
        <a rel="next" style="float:right" class="a-hover"href="/book/ch04-02.html">Internet Explorer Automation <i class=" icon-double-angle-right"></i></a>
        
      </section>
        </article>
      </div>
    </section>
  </main>
</body>
</html>
